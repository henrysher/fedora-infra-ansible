---

- name: backup database
  cron:
    name: "backup database"
    user: faf
    job: "( pg_dump -Fc faf > /srv/faf/db-backup/backup-$(date '+\\%F').dump ) >> /var/log/faf/db_backup.log 2>&1"
    special_time: daily
    state: present

- name: delete old database backups
  cron:
    name: "delete database backups older than X days"
    user: faf
    job: "find /srv/faf/db-backup/ -mtime +14 -type f -delete"
    special_time: daily
    state: present

- name: Run crons when not devel
  block:
  - name: pull associates
    cron:
      name: "cron for pull associates"
      user: faf
      job: "faf pull-associates -o fedora >> /var/log/faf/pull-associates.log 2>&1"
      special_time: daily
      state: present

  - name: koops_to_xorg.py
    cron:
      name: "koops_to_xorg.py"
      user: faf
      job: "/etc/faf/koops_to_xorg.py >> /var/log/faf/koops-to-xorg.log 2>&1"
      special_time: daily
      state: present

  - name: probable fixes
    cron:
      name: "cron for probable fixes for f{{ item }}"
      user: faf
      job: "faf mark-probably-fixed -o fedora --opsys-release {{ item }} >> /var/log/faf/mark-probably-fixed-f{{ item }}.log 2>&1"
      special_time: daily
      state: present
    loop:
      - "29"
      - "30"
      - "31"

  - name: remove obsolete probable fixes
    cron:
      name: "cron for probable fixes for f{{ item }}"
      user: faf
      job: "faf mark-probably-fixed -o fedora --opsys-release {{ item }} >> /var/log/faf/mark-probably-fixed-f{{ item }}.log 2>&1"
      special_time: daily
      state: absent
    loop:
      - "24"
      - "25"
      - "26"
      - "27"
      - "28"

  - name: update BZ bugs fedora
    cron:
      name: "cron for update BZ bugs fedora"
      user: faf
      job: "faf update-bugs -db fedora-bugzilla >> /var/log/faf/update-bugs.log 2>&1"
      special_time: daily
      state: present

  - name: update BZ bugs centos
    cron:
      name: "cron for update BZ bugs centos"
      user: faf
      job: "faf update-bugs -db centos-mantisbt >> /var/log/faf/update-bugs-centos.log 2>&1"
      special_time: daily
      state: present

  - name: attach BZ bugs centos
    cron:
      name: "cron for attach BZ bugs centos"
      user: faf
      job: "faf attach-centos-bugs >> /var/log/faf/attach-centos-bugs.log 2>&1"
      special_time: daily
      state: present

  - name: archive reports and attachments
    cron:
      name: "faf archive reports and attachments"
      user: faf
      job: "faf archive-reports -d >> /var/log/faf/archive-reports.log 2>&1"
      special_time: daily
      state: present
  when: not devel|bool

- name: install cron for deleting old archives
  cron:
    name: "rotate_faf_archives"
    special_time: "daily"
    job: "find '/srv/faf/reports/archive/' -type f -name '*.tar.xz' -mtime '{{archive_age}}' -delete"
    user: "faf"
